<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Academic Calendar 2025-2026</title>
    <link rel="stylesheet" href="../dist/output.css" />
    <style>
      .calendar-container {
        perspective: 1000px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }

      .calendar-day {
        position: relative;
        aspect-ratio: 1 / 1;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        transform-style: preserve-3d;
        cursor: pointer;
        border-radius: 8px;
      }

      .calendar-day:hover {
        transform: scale(1.15) translateZ(30px);
        z-index: 10;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .calendar-day[data-message]:hover::after {
        content: attr(data-message);
        position: absolute;
        bottom: 105%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #1f2937;
        /* gray-800 */
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.875rem;
        white-space: nowrap;
        z-index: 20;
        pointer-events: none;
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-gray-50 to-slate-20">
    <!--  HEADER  -->
    <div id="header-box">
      <!-- Header update from script.js file  -->
    </div>

    <main class="p-4 md:p-8">
      <div
        class="w-full max-w-7xl mx-auto bg-white/70 backdrop-blur-lg rounded-2xl shadow-lg p-6 md:p-8"
      >
        <div class="flex flex-col md:flex-row gap-8">
          <!-- Left Side: Calendar -->
          <div class="w-full md:w-2/3 calendar-container">
            <div class="flex items-center justify-between mb-6">
              <button
                id="prev-month"
                class="p-2 rounded-full hover:bg-gray-200 transition-colors"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  ></path>
                </svg>
              </button>
              <h2
                id="month-year"
                class="text-2xl md:text-3xl font-bold text-center"
              ></h2>
              <button
                id="next-month"
                class="p-2 rounded-full hover:bg-gray-200 transition-colors"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  ></path>
                </svg>
              </button>
            </div>
            <div
              class="grid grid-cols-7 gap-2 text-center font-medium text-gray-500 mb-2"
            >
              <div>Sun</div>
              <div>Mon</div>
              <div>Tue</div>
              <div>Wed</div>
              <div>Thu</div>
              <div>Fri</div>
              <div>Sat</div>
            </div>
            <div id="calendar-dates" class="calendar-grid">
              <!-- Dates will be generated by JavaScript -->
            </div>
            <!-- Month Summary -->
            <div id="month-summary" class="mt-6">
              <!-- Summary will be generated by JavaScript -->
            </div>
          </div>
          <!-- Right Side: Events List -->
          <div
            class="w-full md:w-1/3 border-t-4 md:border-t-0 md:border-l-4 border-gray-200 pt-6 md:pt-0 md:pl-8"
          >
            <div id="events-list" class="h-96 overflow-y-auto pr-2">
              <!-- Events will be generated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <div id="footer-box">
      <!-- Footer updated from script.js file -->
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const backend = "http://localhost:3000";

        /*  DOM  */
        const monthYearEl = document.getElementById("month-year");
        const datesEl = document.getElementById("calendar-dates");
        const prevMonthBtn = document.getElementById("prev-month");
        const nextMonthBtn = document.getElementById("next-month");
        const eventsListEl = document.getElementById("events-list");

        let currentDate = new Date();
        let apiEvents = {};

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        /*  GOVERNMENT HOLIDAYS  */
        const governmentHolidays = {
          "2026-0-1": "New Year's Day",
          "2026-0-13": "Lohri",
          "2026-0-14": "Makar Sankranti / Pongal",
          "2026-0-26": "Republic Day",
          "2026-1-27": "Maha Shivaratri",
          "2026-2-2": "Holi",
          "2026-3-2": "Good Friday",
          "2026-3-4": "Easter Sunday",
          "2026-5-6": "Bakrid",
        };

        /*  FETCH EVENTS  */
        async function fetchEventsFromAPI() {
          try {
            const res = await fetch(`${backend}/api/college/get-events`);
            const json = await res.json();

            apiEvents = {};

            if (json.success && Array.isArray(json.AllEvents)) {
              json.AllEvents.forEach((ev) => {
                const d = new Date(ev.date);
                const key = `${d.getUTCFullYear()}-${d.getUTCMonth()}-${d.getUTCDate()}`;

                if (!apiEvents[key]) apiEvents[key] = [];
                apiEvents[key].push(ev.events);
              });
            }

            console.log("API EVENTS MAP:", apiEvents);
          } catch (err) {
            console.error("API Fetch Failed:", err);
          }
        }

        /*  DAY INFO  */
        function getDayInfo(date) {
          const y = date.getFullYear();
          const m = date.getMonth();
          const d = date.getDate();
          const dow = date.getDay();
          const id = `${y}-${m}-${d}`;

          let type = "working";
          let color = "#ffffff";
          let message = "";

          if (governmentHolidays[id]) {
            type = "holiday";
            color = "#5A5AF6";
            message = governmentHolidays[id];
          } else if (dow === 0) {
            type = "holiday";
            color = "#ff0000";
          } else if (apiEvents[id]) {
            type = "event";
            color = "#22c55e";
            message = apiEvents[id].join(", ");
          }

          return { type, color, message };
        }

        /*  RENDER CALENDAR  */
        function renderCalendar() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();

          monthYearEl.textContent = `${monthNames[month]} ${year}`;
          datesEl.innerHTML = "";

          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          for (let i = 0; i < firstDay; i++) {
            datesEl.appendChild(document.createElement("div"));
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const info = getDayInfo(date);

            const el = document.createElement("div");
            el.className = `calendar-day flex items-center justify-center font-bold text-lg
                ${info.type === "working" ? "text-gray-800" : "text-white"}`;
            el.style.backgroundColor = info.color;
            el.textContent = day;

            if (info.message) el.dataset.message = info.message;

            datesEl.appendChild(el);
          }

          renderEventsList(year, month);
          updateButtons();
        }

        /*  EVENTS LIST (RIGHT SIDE)  */
        function renderEventsList(year, month) {
          eventsListEl.innerHTML = "";

          const sections = { events: [], holidays: [] };

          Object.keys(apiEvents).forEach((key) => {
            const [y, m, d] = key.split("-").map(Number);
            if (y === year && m === month) {
              apiEvents[key].forEach((e) =>
                sections.events.push({ day: d, msg: e })
              );
            }
          });

          Object.keys(governmentHolidays).forEach((key) => {
            const [y, m, d] = key.split("-").map(Number);
            if (y === year && m === month) {
              sections.holidays.push({ day: d, msg: governmentHolidays[key] });
            }
          });

          const renderSection = (title, list, color) => {
            if (!list.length) return;
            const box = document.createElement("div");
            box.innerHTML = `<h4 class="text-lg font-semibold mb-3">${title}</h4>`;
            const ul = document.createElement("ul");
            ul.className = "list-disc pl-5 space-y-2";

            list
              .sort((a, b) => a.day - b.day)
              .forEach((i) => {
                ul.innerHTML += `<li><b style="color:${color}">${i.day}:</b> ${i.msg}</li>`;
              });

            box.appendChild(ul);
            eventsListEl.appendChild(box);
            eventsListEl.appendChild(document.createElement("hr"));
          };

          renderSection("Monthly Events", sections.events, "#16a34a");
          renderSection("Government Holidays", sections.holidays, "#dc2626");

          if (!sections.events.length && !sections.holidays.length) {
            eventsListEl.innerHTML = `<p class="text-gray-500">No events this month.</p>`;
          }
        }

        /*  BUTTON LIMITS  */
        function updateButtons() {
          prevMonthBtn.disabled = false;
          nextMonthBtn.disabled = false;
        }

        /*  MONTH SWITCH  */
        prevMonthBtn.onclick = () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        };

        nextMonthBtn.onclick = () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        };

        /*  Rendering  */
        (async () => {
          await fetchEventsFromAPI();
          renderCalendar();
        })();
      });
    </script>

    <script src="./script.js"></script>
  </body>
</html>
