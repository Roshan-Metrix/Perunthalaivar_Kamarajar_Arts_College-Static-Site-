<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Courses - University Management</title>
    <link rel="stylesheet" href="../dist/output.css" />
  </head>

  <body>
    <div id="header-box"></div>

    <main class="container mx-auto px-6 py-12">
      <!-- Courses View -->
      <div id="courses-view">
        <h2 class="text-3xl font-bold mb-6">Available Courses</h2>

        <input
          type="text"
          id="searchInput"
          placeholder="Search courses..."
          class="w-full mb-6 p-3 border rounded-lg"
        />

        <div id="courses-list" class="space-y-6"></div>
      </div>

      <!-- Course Details -->
      <div id="course-details-view" class="hidden">
        <button
          id="backToCoursesBtn"
          class="text-gray-600 hover:text-yellow-600 font-semibold mb-4"
        >
          ‚Üê Back to Courses
        </button>

        <h2 id="course-title" class="text-4xl font-bold"></h2>
        <p id="course-description" class="text-gray-600 mt-2 mb-6"></p>

        <h3 class="text-2xl font-bold mb-4">Course Files</h3>
        <div id="files-list" class="space-y-4"></div>
      </div>
    </main>

    <div id="footer-box"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_BASE = "http://localhost:3000/api/college";

        const coursesData = [
          {
            id: 1,
            name: "B.A (Tamil)",
            description: "Bachelor of Arts in Tamil literature.",
            files: [
              {
                name: "B.A (Tamil) - Syllabus",
                description: "Complete course syllabus for the year.",
                url: "../images/pdfs/B.A(Tamil).pdf",
              },
            ],
          },
          {
            id: 2,
            name: "B.Sc (Mathematics)",
            description: "Bachelor of Science in Mathematics.",
            files: [
              {
                name: "Maths - Syllabus",
                description: "Complete course syllabus for the year.",
                url: "../images/pdfs/B.Sc(Maths).pdf",
              },
            ],
          },
          {
            id: 3,
            name: "B.B.A (Tourism)",
            description: "Bachelor of Business Administration in Tourism.",
            files: [
              {
                name: "Syllabus",
                description: "Complete course syllabus for the year.",
                url: "../images/pdfs/B.B.A(Tourism).pdf",
              },
            ],
          },
          {
            id: 4,
            name: "B.C.A (Computer Application)",
            description: "Bachelor of Computer Applications.",
            files: [
              {
                name: "Syllabus",
                description: "Complete course syllabus for the year.",
                url: "../images/pdfs/B.C.A.pdf",
              },
            ],
          },
          {
            id: 5,
            name: "B.Com",
            description: "Bachelor of Commerce.",
            files: [
              {
                name: "Syllabus",
                description: "Complete course syllabus for the year.",
                url: "../images/pdfs/B.Com(General).pdf",
              },
            ],
          },
        ];

        const coursesView = document.getElementById("courses-view");
        const detailsView = document.getElementById("course-details-view");
        const coursesList = document.getElementById("courses-list");
        const filesList = document.getElementById("files-list");
        const title = document.getElementById("course-title");
        const desc = document.getElementById("course-description");
        const backBtn = document.getElementById("backToCoursesBtn");
        const searchInput = document.getElementById("searchInput");

        /*  FETCH BACKEND FILES  */
        async function fetchBackendFiles(subName) {
          try {
            const res = await fetch(
              `${API_BASE}/get-course-files/${encodeURIComponent(subName)}`
            );
            const data = await res.json();
            return data.success ? data.files : [];
          } catch (err) {
            console.error(err);
            return [];
          }
        }

        /*  RENDER COURSES  */
        function renderCourses() {
          const term = searchInput.value.toLowerCase();
          coursesList.innerHTML = "";

          coursesData
            .filter((c) => c.name.toLowerCase().includes(term))
            .forEach((course) => {
              const div = document.createElement("div");
              div.className = "bg-white p-6 rounded-lg shadow cursor-pointer";
              div.innerHTML = `
                    <h3 class="text-xl font-bold">${course.name}</h3>
                    <p class="text-gray-600">${course.description}</p>
                `;
              div.onclick = () => openCourse(course);
              coursesList.appendChild(div);
            });
        }

        /*  OPEN COURSE  */
        async function openCourse(course) {
          coursesView.classList.add("hidden");
          detailsView.classList.remove("hidden");

          title.textContent = course.name;
          desc.textContent = course.description;
          filesList.innerHTML = `<p class="text-gray-500">Loading...</p>`;

          // Static files
          const staticFiles = course.files || [];

          //  Backend files
          const backendFiles = await fetchBackendFiles(course.name);

          //  Merge (static + backend)
          const merged = [
            ...staticFiles,
            ...backendFiles.map((f) => ({
              name: f.file_name,
              description: f.file_desc || "",
              url: "http://localhost:3000" + f.file_path,
            })),
          ];

          renderFiles(merged);
        }

        /*  RENDER FILES  */
        function renderFiles(files) {
          filesList.innerHTML = "";

          if (!files.length) {
            filesList.innerHTML = `<p class="text-gray-500">No files found.</p>`;
            return;
          }

          files.forEach((file) => {
            const div = document.createElement("div");
            div.className = "bg-white p-4 rounded shadow flex items-center";

            div.innerHTML = `
                <i class="fas fa-file-pdf text-red-500 text-2xl mr-4"></i>
                <div class="flex-grow">
                    <p class="font-semibold">${file.name}</p>
                    <p class="text-sm text-gray-500">${file.description}</p>
                </div>
                <a href="${file.url}" target="_blank"
                    class="bg-yellow-100 px-3 py-1 rounded">
                    Download
                </a>
            `;
            filesList.appendChild(div);
          });
        }

        backBtn.onclick = () => {
          detailsView.classList.add("hidden");
          coursesView.classList.remove("hidden");
        };

        searchInput.oninput = renderCourses;

        renderCourses();
      });
    </script>

    <script src="./script.js"></script>
  </body>
</html>
